<script>
  const shooter = document.getElementById('shooter');
  const bullet = document.getElementById('bullet');
  const gameBox = document.getElementById('gameBox');
  const gameOverDisplay = document.getElementById('gameOver');
  const scoreDisplay = document.getElementById('score');
  const livesDisplay = document.getElementById('lives');
  const timeDisplay = document.getElementById('time');
  const questionDisplay = document.getElementById('questionDisplay');

  let keys = {};
  let bulletInterval;
  let answerElements = [];
  let correctAnswer;
  let score = 0;
  let lives = 3;
  let gameActive = true;
  let timer = 20;
  let timerInterval;

  function getRandom(min, max, exclude = []) {
    let num;
    do {
      num = Math.floor(Math.random() * (max - min + 1)) + min;
    } while (exclude.includes(num));
    return num;
  }

  function generateQuestion() {
    let a = getRandom(1, 10);
    let b = getRandom(1, 10);
    correctAnswer = a;
    questionDisplay.textContent = `Solve: x + ${b} = ${a + b}`;
    return correctAnswer;
  }

  function startTimer() {
    clearInterval(timerInterval);
    timer = 20;
    timeDisplay.textContent = timer;
    timerInterval = setInterval(() => {
      if (!gameActive) return clearInterval(timerInterval);
      timer--;
      timeDisplay.textContent = timer;
      if (timer <= 0) {
        clearInterval(timerInterval);
        lives--;
        livesDisplay.textContent = lives;
        gameOverDisplay.textContent = "⏳ Time's up!";
        if (lives <= 0) return endGame();
        setTimeout(renderQuestion, 1000);
      }
    }, 1000);
  }

  function renderQuestion() {
    if (!gameActive) return;
    answerElements.forEach(el => el.remove());
    answerElements = [];

    correctAnswer = generateQuestion();
    let choices = [correctAnswer];
    for (let i = 1; i < 4; i++) {
      choices.push(getRandom(correctAnswer - 5, correctAnswer + 5, choices));
    }

    choices = choices.sort(() => Math.random() - 0.5); // Shuffle

    choices.forEach(val => {
      const choice = document.createElement('div');
      choice.className = 'choice';
      choice.textContent = val;
      choice.dataset.answer = val;
      choice.style.top = `${getRandom(50, gameBox.clientHeight - 150)}px`;
      choice.style.left = `${getRandom(50, gameBox.clientWidth - 100)}px`;
      gameBox.appendChild(choice);
      answerElements.push(choice);
    });

    gameOverDisplay.textContent = '';
    startTimer();
  }

  function shootBullet() {
    if (!gameActive || bullet.style.display === 'block') return;

    bullet.style.display = 'block';
    bullet.style.left = `${shooter.offsetLeft + shooter.offsetWidth / 2 - 3}px`;
    bullet.style.top = `${shooter.offsetTop}px`;

    clearInterval(bulletInterval);
    bulletInterval = setInterval(() => {
      bullet.style.top = `${bullet.offsetTop - 10}px`;
      if (bullet.offsetTop <= 0) {
        bullet.style.display = 'none';
        clearInterval(bulletInterval);
      }

      answerElements.forEach(target => {
        const b = bullet.getBoundingClientRect();
        const t = target.getBoundingClientRect();
        const g = gameBox.getBoundingClientRect();

        if (
          b.top <= t.bottom &&
          b.bottom >= t.top &&
          b.left <= t.right &&
          b.right >= t.left
        ) {
          clearInterval(bulletInterval);
          bullet.style.display = 'none';
          const selected = parseInt(target.dataset.answer);

          if (selected === correctAnswer) {
            score++;
            gameOverDisplay.textContent = "✔ Correct!";
          } else {
            lives--;
            gameOverDisplay.textContent = "✘ Wrong!";
            if (lives <= 0) return endGame();
          }

          scoreDisplay.textContent = score;
          livesDisplay.textContent = lives;
          setTimeout(renderQuestion, 800);
        }
      });
    }, 30);
  }

  function moveShooter() {
    const speed = 6;
    const leftLimit = 0;
    const rightLimit = gameBox.clientWidth - shooter.clientWidth;
    let currentLeft = parseInt(window.getComputedStyle(shooter).left);

    if (keys['ArrowLeft'] || keys['a']) {
      shooter.style.left = `${Math.max(leftLimit, currentLeft - speed)}px`;
    }
    if (keys['ArrowRight'] || keys['d']) {
      shooter.style.left = `${Math.min(rightLimit, currentLeft + speed)}px`;
    }

    if (gameActive) requestAnimationFrame(moveShooter);
  }

  function endGame() {
    gameActive = false;
    clearInterval(timerInterval);
    gameOverDisplay.textContent = "💀 Game Over! Final Score: " + score;
    answerElements.forEach(el => el.remove());
  }

  document.addEventListener("keydown", e => {
    keys[e.key] = true;
    if ((e.key === " " || e.key === "Enter") && gameActive) {
      shootBullet();
    }
  });

  document.addEventListener("keyup", e => keys[e.key] = false);

  function initGame() {
    shooter.style.left = `${gameBox.clientWidth / 2 - shooter.clientWidth / 2}px`;
    gameActive = true;
    score = 0;
    lives = 3;
    scoreDisplay.textContent = score;
    livesDisplay.textContent = lives;
    renderQuestion();
    moveShooter();
  }

  window.onload = initGame;
</script>
